{% extends "Base.html" %}
{% block title %}Pedidos por mesa{% endblock %}
{% block header_title %}Pedidos por mesa{% endblock %}

{% block content %}

<div class="container-xxl">

  <!-- Filtros -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button type="button" class="btn btn-light btn-sm filter-btn active" data-filter="all">
      Todas as mesas
    </button>
    <button type="button" class="btn btn-outline-light btn-sm filter-btn" data-filter="ocupada">
      Ocupadas
    </button>
    <button type="button" class="btn btn-outline-light btn-sm filter-btn" data-filter="reservada">
      Reservadas
    </button>
    <button type="button" class="btn btn-outline-light btn-sm filter-btn" data-filter="pedido">
      Pedidos
    </button>
    <button type="button" class="btn btn-outline-light btn-sm filter-btn" data-filter="livre">
      Livre
    </button>
  </div>

  <!-- Lista de mesas -->
  <div class="vstack gap-3">
    {% for mp in mesas_pedidos %}
    <div class="mesa-card card card-glass"
         data-status="{% if mp.mesa.ocupada %}ocupada{% elif mp.mesa.reservada %}reservada{% else %}livre{% endif %}"
         data-pedido="{% if mp.pedidos %}pedido{% else %}sem-pedido{% endif %}">
      <div class="card-body">

        <!-- Cabeçalho da mesa -->
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h3 class="h3 mb-0">Mesa {{ mp.mesa.numero }}</h3>
          <div class="d-flex gap-2">
            {% if mp.mesa.ocupada %}
              <span class="badge text-bg-warning">ocupada</span>
            {% endif %}
            {% if mp.mesa.reservada %}
              <span class="badge text-bg-info">reservada</span>
            {% endif %}
            {% if not mp.mesa.ocupada and not mp.mesa.reservada %}
              <span class="badge text-bg-success">livre</span>
            {% endif %}
          </div>
        </div>

        <!-- Pedidos da mesa -->
        {% if mp.pedidos %}
          <ul class="list-group list-group-flush">
            {% for p in mp.pedidos %}
              <li class="list-group-item bg-transparent text-white">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Pedido #{{ p.id }}</div>
                  <span class="badge
                    {% if p.status == 'P' %}text-bg-warning
                    {% elif p.status == 'E' %}text-bg-info
                    {% elif p.status == 'C' %}text-bg-success
                    {% else %}text-bg-primary{% endif %}">
                    {{ p.get_status_display }}
                  </span>
                </div>
                <div class="text-secondary small">Criado em {{ p.criado_em|date:"d/m/Y, H:i" }}</div>

                {% with itens=p.itens_pedido.all %}
                  {% if itens %}
                    <ul class="mt-2 small ps-4">
                      {% for ip in itens %}
                        <li>
                          {{ ip.quantidade }}× {{ ip.item.nome }} — R$ {{ ip.item.preco|default_if_none:0|floatformat:2 }}
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-secondary mb-0">Sem pedidos.</p>
        {% endif %}

      </div>
    </div>
    {% empty %}
      <div class="text-secondary">Nenhuma mesa encontrada.</div>
    {% endfor %}
  </div>
</div>

<!-- Filtro (JS simples) -->
<script>
(function(){
  const btns = document.querySelectorAll('.filter-btn');
  const cards = document.querySelectorAll('.mesa-card');

  function apply(filter){
    cards.forEach(card => {
      const st = card.dataset.status;     // ocupada | reservada | livre
      const pd = card.dataset.pedido;     // pedido | sem-pedido

      let show = false;
      if (filter === 'all') show = true;
      else if (filter === 'pedido') show = (pd === 'pedido');
      else show = (st === filter);

      card.classList.toggle('d-none', !show);
    });
  }

  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      btns.forEach(x=>x.classList.remove('active','btn-light'));
      btns.forEach(x=>x.classList.add('btn-outline-light'));
      b.classList.remove('btn-outline-light');
      b.classList.add('btn-light','active');
      apply(b.dataset.filter);
    });
  });
})();
</script>

{% endblock %}
